# scheduler

> Vue 3 中的调度器（scheduler）是其响应式系统的核心部分之一，负责优化和管理异步更新，以提高应用的性能和响应速度。与 Vue 2 类似，Vue 3 的调度器确保组件的更新是异步和批量进行的，但它利用了 Vue 3 响应式系统的新特性和改进来实现更高效的更新策略。

## 异步更新

在 Vue 3 中，当响应式数据变化时（例如，通过 reactive 或 ref 修改数据），视图的更新不会立即执行。相反，这些更新会被加入到一个异步队列中。

Vue 3 的调度器会在适当的时机批量执行这个队列中的更新任务，**通常是在所有同步任务完成后的微任务队列中**。这种机制有助于避免不必要的重复渲染和计算，提高应用性能。

## 微任务队列

Vue 3 的调度器使用 JavaScript 的微任务（microtask）队列来管理异步更新。微任务队列的特点是在当前宏任务（包括 DOM 渲染）完成后、下一个宏任务开始前执行。Vue 3 通常通过 Promise.then 或 queueMicrotask API 将更新任务加入微任务队列。

## nextTick

Vue 提供了 nextTick 函数，允许开发者在所有当前队列的 DOM 更新完成后执行回调。这对于需要在 DOM 更新后执行操作的场景非常有用。


## 异步队列的处理

Vue 3 的调度器会在每个事件循环的末尾（通常是通过微任务队列）处理这个异步队列，具体步骤如下：

1. 去重：如果同一个组件在同一事件循环中多次触发更新（即它的渲染函数被多次加入队列），调度器会将这些更新合并，每个组件在当前事件循环中只会被更新一次。
2. 排序：Vue 3 的调度器还会尝试对队列中的任务进行排序，以确保父组件总是在子组件之前更新。这有助于避免不一致的更新顺序带来的潜在问题。
3. 执行更新：一旦队列被处理，队列中的每个更新任务都会被执行，这通常涉及到对组件的虚拟 DOM 树进行重新计算，并应用必要的 DOM 更新。