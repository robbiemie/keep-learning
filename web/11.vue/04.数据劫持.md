# 数据劫持

> 数据劫持（Data Observation）是 Vue.js 中实现响应式的核心机制之一。它通过 `Object.defineProperty()` 方法来实现对数据对象的属性进行劫持，从而监听属性的读取和写入操作，实现了对数据的观测。

```js
// 定义 Observer 类
function Observer(data) {
  // 遍历数据对象的所有属性
  for (var key in data) {
    if (data.hasOwnProperty(key)) {
      defineReactive(data, key, data[key]); // 对每个属性进行劫持
    }
  }
}

// 定义 defineReactive 函数，用来对属性进行劫持
function defineReactive(obj, key, val) {
  // 为每个属性创建一个 Dep 对象
  var dep = new Dep();

  // 递归地对属性值进行劫持，使其也变成响应式
  var childOb = observe(val);

  // 使用 Object.defineProperty() 方法劫持属性
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: function() {
      if (Dep.target) {
        dep.depend(); // 收集依赖
        if (childOb) {
          childOb.dep.depend(); // 收集子对象的依赖
        }
      }
      return val; // 返回属性值
    },
    set: function(newVal) {
      if (val === newVal) {
        return; // 如果新值与旧值相同，则不进行更新
      }
      val = newVal; // 更新属性值
      dep.notify(); // 通知所有订阅者进行更新
    }
  });
}

// 定义 observe 函数，用来递归地对属性值进行劫持
function observe(value) {
  if (!value || typeof value !== 'object') {
    return; // 如果值为空或者不是对象，则不进行劫持
  }
  return new Observer(value);
}

// 定义 Dep 类，用来收集和管理依赖
function Dep() {
  this.subs = []; // 存储所有订阅者
}

// Dep 类的原型方法，用来添加订阅者
Dep.prototype.addSub = function(sub) {
  this.subs.push(sub);
};

// Dep 类的原型方法，用来移除订阅者
Dep.prototype.removeSub = function(sub) {
  var index = this.subs.indexOf(sub);
  if (index !== -1) {
    this.subs.splice(index, 1);
  }
};

// Dep 类的原型方法，用来通知所有订阅者进行更新
Dep.prototype.notify = function() {
  this.subs.forEach(function(sub) {
    sub.update();
  });
};

// 定义 Watcher 类，用来表示订阅者
function Watcher(vm, expOrFn, cb) {
  this.vm = vm;
  this.expOrFn = expOrFn;
  this.cb = cb;
  this.value = this.get(); // 获取当前属性值
}

// Watcher 类的原型方法，用来获取当前属性值
Watcher.prototype.get = function() {
  Dep.target = this; // 将当前订阅者指定为全局的 target
  var value = this.vm[this.expOrFn]; // 获取当前属性值，从而触发 getter
  Dep.target = null; // 清除全局的 target
  return value;
};

// Watcher 类的原型方法，用来在属性值发生变化时更新视图
Watcher.prototype.update = function() {
  var value = this.get(); // 获取最新的属性值
  if (value !== this.value) {
    this.value = value;
    this.cb.call(this.vm, value); // 执行回调函数，更新视图
  }
};

// 示例数据
var data = {
  message: 'Hello, Vue!'
};

// 创建 Observer 实例，对数据进行劫持
observe(data);

// 创建 Watcher 实例，监视数据的变化
new Watcher(data, 'message', function(value) {
  console.log('Message changed: ' + value); // 当数据变化时，输出新值
});

// 修改数据，触发数据劫持和响应式更新
data.message = 'Hello, World!';

```