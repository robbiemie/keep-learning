"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([[5177],{2644:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>u,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"web/vue/\u6570\u636e\u52ab\u6301","title":"\u6570\u636e\u52ab\u6301","description":"\u6570\u636e\u52ab\u6301\uff08Data Observation\uff09\u662f Vue.js \u4e2d\u5b9e\u73b0\u54cd\u5e94\u5f0f\u7684\u6838\u5fc3\u673a\u5236\u4e4b\u4e00\u3002\u5b83\u901a\u8fc7 Object.defineProperty() \u65b9\u6cd5\u6765\u5b9e\u73b0\u5bf9\u6570\u636e\u5bf9\u8c61\u7684\u5c5e\u6027\u8fdb\u884c\u52ab\u6301\uff0c\u4ece\u800c\u76d1\u542c\u5c5e\u6027\u7684\u8bfb\u53d6\u548c\u5199\u5165\u64cd\u4f5c\uff0c\u5b9e\u73b0\u4e86\u5bf9\u6570\u636e\u7684\u89c2\u6d4b\u3002","source":"@site/markdown/web/11.vue/04.\u6570\u636e\u52ab\u6301.md","sourceDirName":"web/11.vue","slug":"/web/vue/\u6570\u636e\u52ab\u6301","permalink":"/keep-learning/docs/web/vue/\u6570\u636e\u52ab\u6301","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":4,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Vue \u54cd\u5e94\u5f0f\u539f\u7406","permalink":"/keep-learning/docs/web/vue/vue\u54cd\u5e94\u5f0f\u539f\u7406"},"next":{"title":"\u4f9d\u8d56\u6536\u96c6","permalink":"/keep-learning/docs/web/vue/\u4f9d\u8d56\u6536\u96c6"}}');var r=t(4848),s=t(8453);const i={},o="\u6570\u636e\u52ab\u6301",u={},l=[];function c(n){const e={blockquote:"blockquote",code:"code",h1:"h1",header:"header",p:"p",pre:"pre",...(0,s.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"\u6570\u636e\u52ab\u6301",children:"\u6570\u636e\u52ab\u6301"})}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsxs)(e.p,{children:["\u6570\u636e\u52ab\u6301\uff08Data Observation\uff09\u662f Vue.js \u4e2d\u5b9e\u73b0\u54cd\u5e94\u5f0f\u7684\u6838\u5fc3\u673a\u5236\u4e4b\u4e00\u3002\u5b83\u901a\u8fc7 ",(0,r.jsx)(e.code,{children:"Object.defineProperty()"})," \u65b9\u6cd5\u6765\u5b9e\u73b0\u5bf9\u6570\u636e\u5bf9\u8c61\u7684\u5c5e\u6027\u8fdb\u884c\u52ab\u6301\uff0c\u4ece\u800c\u76d1\u542c\u5c5e\u6027\u7684\u8bfb\u53d6\u548c\u5199\u5165\u64cd\u4f5c\uff0c\u5b9e\u73b0\u4e86\u5bf9\u6570\u636e\u7684\u89c2\u6d4b\u3002"]}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-js",children:"// \u5b9a\u4e49 Observer \u7c7b\nfunction Observer(data) {\n  // \u904d\u5386\u6570\u636e\u5bf9\u8c61\u7684\u6240\u6709\u5c5e\u6027\n  for (var key in data) {\n    if (data.hasOwnProperty(key)) {\n      defineReactive(data, key, data[key]); // \u5bf9\u6bcf\u4e2a\u5c5e\u6027\u8fdb\u884c\u52ab\u6301\n    }\n  }\n}\n\n// \u5b9a\u4e49 defineReactive \u51fd\u6570\uff0c\u7528\u6765\u5bf9\u5c5e\u6027\u8fdb\u884c\u52ab\u6301\nfunction defineReactive(obj, key, val) {\n  // \u4e3a\u6bcf\u4e2a\u5c5e\u6027\u521b\u5efa\u4e00\u4e2a Dep \u5bf9\u8c61\n  var dep = new Dep();\n\n  // \u9012\u5f52\u5730\u5bf9\u5c5e\u6027\u503c\u8fdb\u884c\u52ab\u6301\uff0c\u4f7f\u5176\u4e5f\u53d8\u6210\u54cd\u5e94\u5f0f\n  var childOb = observe(val);\n\n  // \u4f7f\u7528 Object.defineProperty() \u65b9\u6cd5\u52ab\u6301\u5c5e\u6027\n  Object.defineProperty(obj, key, {\n    enumerable: true,\n    configurable: true,\n    get: function() {\n      if (Dep.target) {\n        dep.depend(); // \u6536\u96c6\u4f9d\u8d56\n        if (childOb) {\n          childOb.dep.depend(); // \u6536\u96c6\u5b50\u5bf9\u8c61\u7684\u4f9d\u8d56\n        }\n      }\n      return val; // \u8fd4\u56de\u5c5e\u6027\u503c\n    },\n    set: function(newVal) {\n      if (val === newVal) {\n        return; // \u5982\u679c\u65b0\u503c\u4e0e\u65e7\u503c\u76f8\u540c\uff0c\u5219\u4e0d\u8fdb\u884c\u66f4\u65b0\n      }\n      val = newVal; // \u66f4\u65b0\u5c5e\u6027\u503c\n      dep.notify(); // \u901a\u77e5\u6240\u6709\u8ba2\u9605\u8005\u8fdb\u884c\u66f4\u65b0\n    }\n  });\n}\n\n// \u5b9a\u4e49 observe \u51fd\u6570\uff0c\u7528\u6765\u9012\u5f52\u5730\u5bf9\u5c5e\u6027\u503c\u8fdb\u884c\u52ab\u6301\nfunction observe(value) {\n  if (!value || typeof value !== 'object') {\n    return; // \u5982\u679c\u503c\u4e3a\u7a7a\u6216\u8005\u4e0d\u662f\u5bf9\u8c61\uff0c\u5219\u4e0d\u8fdb\u884c\u52ab\u6301\n  }\n  return new Observer(value);\n}\n\n// \u5b9a\u4e49 Dep \u7c7b\uff0c\u7528\u6765\u6536\u96c6\u548c\u7ba1\u7406\u4f9d\u8d56\nfunction Dep() {\n  this.subs = []; // \u5b58\u50a8\u6240\u6709\u8ba2\u9605\u8005\n}\n\n// Dep \u7c7b\u7684\u539f\u578b\u65b9\u6cd5\uff0c\u7528\u6765\u6dfb\u52a0\u8ba2\u9605\u8005\nDep.prototype.addSub = function(sub) {\n  this.subs.push(sub);\n};\n\n// Dep \u7c7b\u7684\u539f\u578b\u65b9\u6cd5\uff0c\u7528\u6765\u79fb\u9664\u8ba2\u9605\u8005\nDep.prototype.removeSub = function(sub) {\n  var index = this.subs.indexOf(sub);\n  if (index !== -1) {\n    this.subs.splice(index, 1);\n  }\n};\n\n// Dep \u7c7b\u7684\u539f\u578b\u65b9\u6cd5\uff0c\u7528\u6765\u901a\u77e5\u6240\u6709\u8ba2\u9605\u8005\u8fdb\u884c\u66f4\u65b0\nDep.prototype.notify = function() {\n  this.subs.forEach(function(sub) {\n    sub.update();\n  });\n};\n\n// \u5b9a\u4e49 Watcher \u7c7b\uff0c\u7528\u6765\u8868\u793a\u8ba2\u9605\u8005\nfunction Watcher(vm, expOrFn, cb) {\n  this.vm = vm;\n  this.expOrFn = expOrFn;\n  this.cb = cb;\n  this.value = this.get(); // \u83b7\u53d6\u5f53\u524d\u5c5e\u6027\u503c\n}\n\n// Watcher \u7c7b\u7684\u539f\u578b\u65b9\u6cd5\uff0c\u7528\u6765\u83b7\u53d6\u5f53\u524d\u5c5e\u6027\u503c\nWatcher.prototype.get = function() {\n  Dep.target = this; // \u5c06\u5f53\u524d\u8ba2\u9605\u8005\u6307\u5b9a\u4e3a\u5168\u5c40\u7684 target\n  var value = this.vm[this.expOrFn]; // \u83b7\u53d6\u5f53\u524d\u5c5e\u6027\u503c\uff0c\u4ece\u800c\u89e6\u53d1 getter\n  Dep.target = null; // \u6e05\u9664\u5168\u5c40\u7684 target\n  return value;\n};\n\n// Watcher \u7c7b\u7684\u539f\u578b\u65b9\u6cd5\uff0c\u7528\u6765\u5728\u5c5e\u6027\u503c\u53d1\u751f\u53d8\u5316\u65f6\u66f4\u65b0\u89c6\u56fe\nWatcher.prototype.update = function() {\n  var value = this.get(); // \u83b7\u53d6\u6700\u65b0\u7684\u5c5e\u6027\u503c\n  if (value !== this.value) {\n    this.value = value;\n    this.cb.call(this.vm, value); // \u6267\u884c\u56de\u8c03\u51fd\u6570\uff0c\u66f4\u65b0\u89c6\u56fe\n  }\n};\n\n// \u793a\u4f8b\u6570\u636e\nvar data = {\n  message: 'Hello, Vue!'\n};\n\n// \u521b\u5efa Observer \u5b9e\u4f8b\uff0c\u5bf9\u6570\u636e\u8fdb\u884c\u52ab\u6301\nobserve(data);\n\n// \u521b\u5efa Watcher \u5b9e\u4f8b\uff0c\u76d1\u89c6\u6570\u636e\u7684\u53d8\u5316\nnew Watcher(data, 'message', function(value) {\n  console.log('Message changed: ' + value); // \u5f53\u6570\u636e\u53d8\u5316\u65f6\uff0c\u8f93\u51fa\u65b0\u503c\n});\n\n// \u4fee\u6539\u6570\u636e\uff0c\u89e6\u53d1\u6570\u636e\u52ab\u6301\u548c\u54cd\u5e94\u5f0f\u66f4\u65b0\ndata.message = 'Hello, World!';\n\n"})}),"\n",(0,r.jsx)(e.p,{children:"case2:"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-js",children:'// \u53d1\u5e03\u8005\nclass Dep{\n  constructor() {\n      this.subs = [];\n  }\n  addSubs(sub) {\n      if (this.subs.indexOf(sub) < 0) {\n        // 12.1\u6dfb\u52a0\u5f53\u524dwatcher\u5b9e\u4f8b\n        this.subs.push(sub);\n      }\n  }\n  notify() {\n    // 17.\u901a\u77e5 watcher \u8fdb\u884c\u66f4\u65b0\n    this.subs.forEach(item => item.update())\n  }\n}\nDep.target = null;\n\n// \u8ba2\u9605\u8005\nclass Watcher {\n  constructor(obj, key, updateCb) {\n      // \u5f85\u89c2\u5bdf\u5bf9\u8c61\n      this.data = obj;\n      // \u5f85\u89c2\u5bdf\u5bf9\u8c61\u7684 key\n      this.key = key;\n      // \u56de\u8c03\u51fd\u6570\n      this.updateCb = updateCb;\n      this.value = null;\n      // 8. \u89e6\u53d1\u4e00\u6b21 get\n      this.get();\n  }\n  get() {\n      // 9.\u5c06 watcher \u5b9e\u4f8b\u5bf9\u8c61\u8bbe\u7f6e\u4e3a Dep.target\n      // \u6b64\u65f6 watcher \u5b9e\u4f8b\u5bf9\u8c61\u5305\u542b: {data: {a: 1},key: \'a\', updateCb: Function, value: null}\n      Dep.target = this;\n      // 10.this.data[this.key] \u89e6\u53d1 getter \u4e8b\u4ef6\n      this.value = this.data[this.key];\n      // 13.\u6e05\u7a7a\u5f53\u524d watcher \u5b9e\u4f8b\n      Dep.target = null;\n      return this.value;\n  }\n  update() {\n      // 18.\u83b7\u53d6\u65e7\u7684\u5bf9\u8c61\u5c5e\u6027\u503c \n      const oldValue = this.value;\n      // 19.\u89e6\u53d1\u4e00\u6b21 get \n      // \u91cd\u590d\u6b65\u9aa48\n      const newValue = this.get();\n      // 20.\u6267\u884c\u56de\u8c03\u51fd\u6570\n      this.updateCb(newValue, oldValue);\n  }\n}\n\n// observer\u7c7b \u52ab\u6301\u6570\u636e\n\nclass Observer {\n  constructor(obj) {\n      this.data = obj;\n      // 3.\u5224\u65ad\u662f\u5426\u4e3a\u5bf9\u8c61\n      if (this.data == null || typeof this.data !== "object") {\n          return;\n      }\n      // 4.\u5224\u65ad\u662f\u5426\u4e3a\u6570\u7ec4\u7c7b\u578b\n      if (Array.isArray(this.data)) {\n          this.observeArray();\n      } else {\n          // 5.\u5bf9\u8c61\u7c7b\u578b\n          this.walk();\n      }\n  }\n  walk() {\n      for (let i in this.data) {\n          // 6.\u4e3a\u6bcf\u4e00\u4e2akey\u8fdb\u884c\u54cd\u5e94\u5316\u8bbe\u7f6e\n          // \u590d\u5199getter/setter\u65b9\u6cd5 \n          this.defineReactive(this.data, i);\n      }\n  }\n  observeArray() {\n      for (let i = 0; i < this.data.length; i++) {\n        // 4.1 \u904d\u5386\u6570\u7ec4\u503c\uff0c\u4e3a\u6bcf\u4e00\u4e2a\u503c\u8fdb\u884c\u54cd\u5e94\u5f0f\u5904\u7406\n        // \u91cd\u590d\u6b65\u9aa41\n          observe(this.data[i]);\n      }\n  }\n  defineReactive(obj, key) {\n      let val = obj[key];\n      // \u5bf9\u5c5e\u6027\u503c\u8fdb\u884c\u54cd\u5e94\u5f0f\u5904\u7406\n      // \u975e\u5bf9\u8c61\u7c7b\u578b\u5728 \u6b65\u9aa43 \u76f4\u63a5 return\n      observe(val);\n      // \u521b\u5efa\u4e00\u4e2a\u53d1\u5e03\u8005\u5bf9\u8c61\n      const dep = new Dep();\n      Object.defineProperty(obj, key, {\n          get() {\n            // 11.Dep.target \u4e3a\u5f53\u524d watcher \u5b9e\u4f8b\u5bf9\u8c61\n            if (Dep.target) {\n              // 12.\u52a0\u5165\u5f53\u524d watcher \u5b9e\u4f8b\u5bf9\u8c61\uff0c\u6536\u96c6\u4f9d\u8d56\n              dep.addSubs(Dep.target)\n            }\n            return val;\n          },\n          set(newVal) {\n              if (newVal === val) {\n                  return;\n              }\n              val = newVal;\n              // 15.\u4e3a\u65b0\u503c\u8fdb\u884c\u54cd\u5e94\u5316\u5904\u7406\n              observe(val);\n              // 16.\u53d1\u5e03\u901a\u77e5\u6570\u636e\u66f4\u65b0\n              dep.notify();\n          }\n      })\n  }\n}\n// \u6570\u636e\u76d1\u6d4b\u65b9\u6cd5\nfunction observe(data) {\n  // 2.\u521b\u5efa\u4e00\u4e2aObserver\u5bf9\u8c61\n  new Observer(data);\n}\n\n// \u5199\u4e00\u4e2a\u6700\u7b80\u5355\u7684\u4f8b\u5b50\nconst obj = {\n  a: 1\n};\n\n// 1.\u5c06\u5bf9\u8c61\u8bbe\u7f6e\u4e3a\u54cd\u5e94\u5f0f\nobserve(obj);\n// 7.\u521b\u5efa\u89c2\u5bdf\u8005\u5bf9\u8c61\n// \u5e76\u89c2\u5bdf\u8be5\u5bf9\u8c61\u5c5e\u6027\u503c\u7684\u53d8\u5316\nnew Watcher(obj, "a", (newVal, oldVal) => {\n  // 21.\u51fd\u6570\u56de\u8c03\n  console.log("newVal", newVal);\n  console.log("oldVal", oldVal + \'\\n\');\n});\n// 14.obj.a \u91cd\u65b0\u8d4b\u503c\nobj.a = 2;\nobj.a = 3;\n\n'})})]})}function d(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(c,{...n})}):c(n)}},8453:(n,e,t)=>{t.d(e,{R:()=>i,x:()=>o});var a=t(6540);const r={},s=a.createContext(r);function i(n){const e=a.useContext(s);return a.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:i(n.components),a.createElement(s.Provider,{value:e},n.children)}}}]);